<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>711 Mini Store</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="{{ url_for('static', filename='styles.css') }}" />
</head>
<body>
  <div class="container">
    <header>
      <div class="brand"><span class="seven">7</span><span class="eleven">11</span> Mini Store</div>
    </header>
    <div class="grid">
      <section class="panel">
        <form id="createForm">
          <div>
            <label>Product name</label>
            <input name="product_name" type="text" placeholder="Iced Coffee" required />
          </div>
          <div>
            <label>Price</label>
            <input name="price" type="number" step="0.01" placeholder="2.99" required />
          </div>
          <div>
            <label>Brand</label>
            <input name="brand_name" type="text" placeholder="711" required />
          </div>
          <div>
            <label>Quantity</label>
            <input name="quantity_available" type="number" min="0" placeholder="10" required />
          </div>
          <div>
            <label>Image (optional)</label>
            <input name="image" type="file" accept="image/*" />
          </div>
          <div class="actions">
            <button type="submit">Create product</button>
            <button type="button" class="secondary" id="refreshBtn">Refresh</button>
          </div>
        </form>
      </section>
      <section class="panel products">
        <h2>Products</h2>
        <div class="cards" id="cards"></div>
      </section>
    </div>
  </div>
  <div class="toast" id="toast"></div>

  <!-- Edit Modal -->
  <div id="editModal" class="modal hidden" aria-hidden="true">
    <div class="modal-dialog">
      <div class="modal-header">
        <strong>Edit product</strong>
        <button class="icon-btn close-btn" data-close="editModal" aria-label="Close">âœ•</button>
      </div>
      <form id="editForm" class="modal-body">
        <input type="hidden" name="product_id" />
        <div>
          <label>Name</label>
          <input name="product_name" type="text" required />
        </div>
        <div>
          <label>Price</label>
          <input name="price" type="number" step="0.01" required />
        </div>
        <div>
          <label>Brand</label>
          <input name="brand_name" type="text" required />
        </div>
        <div>
          <label>Quantity</label>
          <input name="quantity_available" type="number" min="0" required />
        </div>
        <div class="actions">
          <button type="submit">Save</button>
          <button type="button" class="secondary" data-close="editModal">Cancel</button>
        </div>
      </form>
    </div>
  </div>

  <!-- Delete Modal -->
  <div id="deleteModal" class="modal hidden" aria-hidden="true">
    <div class="modal-dialog">
      <div class="modal-header">
        <strong>Delete product</strong>
        <button class="icon-btn close-btn" data-close="deleteModal" aria-label="Close">âœ•</button>
      </div>
      <div class="modal-body">
        <p class="muted" id="deletePrompt">Are you sure you want to delete this product?</p>
        <div class="actions">
          <button id="confirmDeleteBtn">Delete</button>
          <button type="button" class="secondary" data-close="deleteModal">Cancel</button>
        </div>
      </div>
    </div>
  </div>
  <script>
    const $ = (s) => document.querySelector(s);
    const cards = $('#cards');
    const toast = $('#toast');

    function showToast(msg, ok=true){
      toast.textContent = msg;
      toast.style.display = 'block';
      toast.style.borderColor = ok ? '#1f5130' : '#51271f';
      setTimeout(()=> toast.style.display = 'none', 2200);
    }

    let stateProducts = [];

    async function loadProducts(){
      cards.innerHTML = '<div class="muted">Loadingâ€¦</div>';
      try {
        const res = await fetch('/products');
        const items = await res.json();
        stateProducts = Array.isArray(items) ? items : [];
        if (!stateProducts.length) {
          cards.innerHTML = '<div class="muted">No products yet.</div>';
          return;
        }
        renderCards(stateProducts);
      } catch (e) {
        cards.innerHTML = `<div class="muted">Failed to load products</div>`;
      }
    }

    $('#refreshBtn').addEventListener('click', loadProducts);

    const fmt = (n) => new Intl.NumberFormat(undefined, { style:'currency', currency:'USD' }).format(Number(n));

    function renderCards(items){
      cards.innerHTML = items.map(p => `
        <article class="card" data-id="${p.product_id}">
          <div class="thumb">${p.image_url ? `<img src="${p.image_url}" alt="${p.product_name}">` : ''}</div>
          <div class="body">
            <div class="row"><strong>${p.product_name}</strong><span class="muted">${fmt(p.price)}</span></div>
            <div class="row"><span class="muted">${p.brand_name}</span><span class="muted">qty: ${p.quantity_available}</span></div>
          </div>
          <div class="card-actions">
            <button class="icon-btn edit-btn" title="Edit" data-id="${p.product_id}">âœŽ</button>
            <button class="icon-btn delete-btn" title="Delete" data-id="${p.product_id}">ðŸ—‘</button>
          </div>
        </article>
      `).join('');
    }

    // Modal helpers
    function toggleModal(id, show){
      const m = document.getElementById(id);
      if (!m) return;
      m.classList[show ? 'remove' : 'add']('hidden');
      m.setAttribute('aria-hidden', show ? 'false' : 'true');
    }

    document.addEventListener('click', (e) => {
      const closeTarget = e.target.closest('[data-close]');
      if (closeTarget){ toggleModal(closeTarget.getAttribute('data-close'), false); }
    });

    // Edit
    document.addEventListener('click', (e) => {
      const btn = e.target.closest('.edit-btn');
      if (!btn) return;
      const id = btn.getAttribute('data-id');
      const product = stateProducts.find(p => p.product_id === id);
      if (!product) return;
      const form = document.getElementById('editForm');
      form.product_id.value = product.product_id;
      form.product_name.value = product.product_name || '';
      form.price.value = product.price;
      form.brand_name.value = product.brand_name || '';
      form.quantity_available.value = product.quantity_available || 0;
      toggleModal('editModal', true);
    });

    document.getElementById('editForm').addEventListener('submit', async (e) => {
      e.preventDefault();
      const fd = new FormData(e.currentTarget);
      const id = fd.get('product_id');
      const payload = {
        product_name: fd.get('product_name'),
        price: Number(fd.get('price')),
        brand_name: fd.get('brand_name'),
        quantity_available: Number(fd.get('quantity_available'))
      };
      try {
        const res = await fetch(`/products/${id}`, { method: 'PATCH', headers:{'Content-Type':'application/json'}, body: JSON.stringify(payload)});
        const data = await res.json();
        if (!res.ok) throw new Error(data.error || 'Failed');
        showToast('Product updated');
        toggleModal('editModal', false);
        await loadProducts();
      } catch(err){ showToast(err.message || 'Update failed', false); }
    });

    // Delete
    let deleteId = null;
    document.addEventListener('click', (e) => {
      const btn = e.target.closest('.delete-btn');
      if (!btn) return;
      deleteId = btn.getAttribute('data-id');
      document.getElementById('deletePrompt').textContent = 'Delete this product permanently?';
      toggleModal('deleteModal', true);
    });

    document.getElementById('confirmDeleteBtn').addEventListener('click', async () => {
      if (!deleteId) return;
      try{
        const res = await fetch(`/products/${deleteId}`, { method: 'DELETE' });
        const data = await res.json();
        if (!res.ok) throw new Error(data.error || 'Failed');
        showToast('Product deleted');
        toggleModal('deleteModal', false);
        deleteId = null;
        await loadProducts();
      }catch(err){ showToast(err.message || 'Delete failed', false); }
    });

    document.getElementById('createForm').addEventListener('submit', async (e) => {
      e.preventDefault();
      const form = e.currentTarget;
      const fd = new FormData(form);
      try {
        const res = await fetch('/products', { method: 'POST', body: fd });
        const data = await res.json();
        if (!res.ok) throw new Error(data.error || 'Failed');
        showToast('Product created');
        if (form && typeof form.reset === 'function') form.reset();
        await loadProducts();
      } catch (err) {
        showToast(err.message || 'Error creating product', false);
      }
    });

    loadProducts();
  </script>
</body>
</html>


